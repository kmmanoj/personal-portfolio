<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>FMEA of a microservice that uses third-party APIs | Manoj Vignesh K M</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="FMEA of a microservice that uses third-party APIs" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How do I simulate failure of an API endpoint that I don’t have control over while performing Failure Mode and Effect Analysis?" />
<meta property="og:description" content="How do I simulate failure of an API endpoint that I don’t have control over while performing Failure Mode and Effect Analysis?" />
<link rel="canonical" href="https://www.kmmanoj.me/2021/01/22/fmea-of-a-microservice-that-uses-third-party-apis.html" />
<meta property="og:url" content="https://www.kmmanoj.me/2021/01/22/fmea-of-a-microservice-that-uses-third-party-apis.html" />
<meta property="og:site_name" content="Manoj Vignesh K M" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-22T23:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="FMEA of a microservice that uses third-party APIs" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-01-22T23:00:00-05:00","datePublished":"2021-01-22T23:00:00-05:00","description":"How do I simulate failure of an API endpoint that I don’t have control over while performing Failure Mode and Effect Analysis?","headline":"FMEA of a microservice that uses third-party APIs","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.kmmanoj.me/2021/01/22/fmea-of-a-microservice-that-uses-third-party-apis.html"},"url":"https://www.kmmanoj.me/2021/01/22/fmea-of-a-microservice-that-uses-third-party-apis.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://www.kmmanoj.me/feed.xml" title="Manoj Vignesh K M" />
    





  
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="https://www.kmmanoj.me">Manoj Vignesh K M</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
                <!-- pass -->
              
                <!-- pass -->
              
                <a class="page-link" href="/experience/">Experience</a>
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <a class="page-link" href="/blogs/">Blogs</a>
              
              <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              
                <!-- pass -->
              </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <a href="/blogs">&lt; To Blog home</a>

<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">FMEA of a microservice that uses third-party APIs</h1>
    <span>
      
        
        <a href="/tag/advanced"><code class="highligher-rouge"><nobr>advanced</nobr></code>&nbsp;</a>
      
        
        <a href="/tag/application"><code class="highligher-rouge"><nobr>application</nobr></code>&nbsp;</a>
      
        
        <a href="/tag/software-engineering"><code class="highligher-rouge"><nobr>software-engineering</nobr></code>&nbsp;</a>
      
    </span>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-01-22T23:00:00-05:00" itemprop="datePublished">Jan 22, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Microservice architecture is an architectural style wherein an application is broken down into independent components that are capable of providing a specific service. When a chain of these components is invoked, a business logic of the application is serviced.</p>

<p>Be it any architecture style, the quality of the software is crucial in providing flawless and trust-worthy service. Intensive testing is key to releasing a quality software. Software engineers perform multiple levels of testing to ensure that the microservice, business logic and eventually the whole application does not misbehave in any case. One such testing process is called the <a href="https://en.wikipedia.org/wiki/Failure_mode_and_effects_analysis">FMEA</a>.</p>

<p><strong>FMEA</strong> stands for Failure Mode and Effect Analysis. It is a process involved in quality testing where one or more components of an application is intentionally brought down (or) the connection failure is simulated to study the behavior of the microservice that depends on the called microservice that failed. This process is critical in ensuring that there is no cascading of failures among the microservices involved in a business logic. Failing to perform FMEA could drift an application to an unstable state or worse display server error containing potentially sensitive information to the end user.</p>

<p>Well, it is relatively easy to bring down a self-owned microservice in the test stage to study the behavior of the dependent microservice in the test stage. What about FMEA of a microservice that depends on a third-party API? One does not have control over the operational status of the third-party API. So, that scopes down to simulating failure of third-party APIs.</p>

<p><strong>Following up, how do I simulate failure of an API endpoint that I don’t have control over?</strong></p>

<h2 id="methodology">Methodology</h2>

<p>Recall or observe a typical implementation of a microservice. There are parts of the code that performs a HTTP(S) request (or could be any other protocol) to an API endpoint. The API endpoint is represented as a constant in the form of a domain name in the implementation. Do you find something interesting in the previous statement?</p>

<p><em>The API endpoint is represented in the form of a <strong>domain name</strong> and <strong>not</strong> in the form of an <strong>IP address</strong>.</em></p>

<p>Leveraging this pattern seen among the implementations, what if one could point the API endpoint domain name to an IP address that is not running the service? Doesn’t it simulate a API call failure?</p>

<p>For example, consider a third-party API endpoint <code class="language-plaintext highlighter-rouge">api.example.com</code> that resolves to <code class="language-plaintext highlighter-rouge">1.2.3.4</code> and provides weather information of a queried location on port 443. A microservice being analysed should be made to believe that <code class="language-plaintext highlighter-rouge">api.example.com</code> resolves to <code class="language-plaintext highlighter-rouge">127.0.0.1</code> , where no service is running at port 443. Consequently, when the microservice is run, it attempts to make an API call to <code class="language-plaintext highlighter-rouge">api.example.com</code> and eventually fails since <code class="language-plaintext highlighter-rouge">127.0.0.1</code> is not running the weather information service at port 443.</p>

<h2 id="how-do-we-do-that">How do we do that?</h2>

<p>DNS cache poisoning!</p>

<p>Let’s analyse how a DNS resolution of a domain name happens in a host. A host crafts a DNS request for the domain name and passes it to the network driver. At this point, the host tries to resolve the query by finding the domain name in its local DNS cache. If not found, then it recursively queries the gateway which checks its local DNS cache (capable of resolving DNS), then to ISP gateway and so on to the actual DNS servers. Observe, we do have control over the host, so let’s attempt to tamper the DNS cache of the host to point the third-party API domain name to an IP address that does not run the specified service, for example, <code class="language-plaintext highlighter-rouge">api.example.com</code> to <code class="language-plaintext highlighter-rouge">127.0.0.1</code></p>

<p>There is a special text file <code class="language-plaintext highlighter-rouge">/etc/hosts</code> in *nix based systems and <code class="language-plaintext highlighter-rouge">C:\Windows\System32\Drivers\etc\hosts</code> in windows systems, which is an extension of the local DNS cache. This is the first place that a host looks up to resolve a DNS query. Bullseye!</p>

<p><strong>Thus, by adding a new row in the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file with the third-party API endpoint pointing to an IP address that is not running the specified service, one could simulate third-party API failure.</strong></p>

<h2 id="dont-talk-show-me-the-code">Don’t talk, show me the code</h2>

<p>Consider a microservice that checks if an input string is a pokemon and/or a python module. For example,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Request:
GET /tensorflow

Response:
{    
    "is_python_module": true,
    "is_pokemon": false
}
</code></pre></div></div>

<h2 id="development">Development</h2>

<p>The following code shows the implementation of the microservice. Observe the two third-party APIs being used, namely:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pypi.org</code>: To identify if the input string is a python module</li>
  <li><code class="language-plaintext highlighter-rouge">pokeapi.co</code>: To identify if the input string is a pokemon</li>
</ul>

<p>It queries the two API endpoint for details pertaining to the input string. Using the obtained information, the microservice updates the response accordingly and returns the result.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">"/&lt;input_string&gt;"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">microservice</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
    <span class="n">pypi_endpoint</span> <span class="o">=</span> <span class="s">"https://pypi.org/simple/{module_name}"</span>
    <span class="n">poke_api_endpoint</span> <span class="o">=</span> <span class="s">"https://pokeapi.co/api/v2/pokemon/{pokemon}"</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">(</span>
        <span class="n">is_python_module</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">is_pokemon</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pypi_response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
            <span class="n">pypi_endpoint</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
                <span class="n">module_name</span><span class="o">=</span><span class="n">input_string</span>
            <span class="p">),</span> 
            <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span>
        <span class="p">)</span>
        <span class="n">py_module_status_code</span> <span class="o">=</span> <span class="n">pypi_response</span><span class="p">.</span><span class="n">status_code</span>
        <span class="n">response</span><span class="p">[</span><span class="s">'is_python_module'</span><span class="p">]</span> <span class="o">=</span> <span class="n">py_module_status_code</span><span class="o">//</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">poke_response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
            <span class="n">poke_api_endpoint</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span>
                <span class="n">pokemon</span><span class="o">=</span><span class="n">input_string</span>
            <span class="p">),</span> 
            <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">poke_response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span> <span class="o">==</span> <span class="s">'Not Found'</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s">'is_pokemon'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="s">'id'</span> <span class="ow">in</span> <span class="n">poke_response</span><span class="p">.</span><span class="nf">json</span><span class="p">():</span>
            <span class="n">response</span><span class="p">[</span><span class="s">'is_pokemon'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">response</span> 

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="testing">Testing</h2>

<p>The following code shows the FMEA test automation for three scenarios (for *nix based systems):</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pokeapi.co</code> is down, while <code class="language-plaintext highlighter-rouge">pypi.org</code> is healthy</li>
  <li><code class="language-plaintext highlighter-rouge">pokeapi.co</code> is healthy, while <code class="language-plaintext highlighter-rouge">pypi.org</code> is down</li>
  <li><code class="language-plaintext highlighter-rouge">pokeapi.co</code> is down, and <code class="language-plaintext highlighter-rouge">pypi.org</code> is down</li>
</ul>

<blockquote>
  <p>NOTE: the test case when both APIs are healthy is skipped intentionally.</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">unittest</span>
<span class="kn">import</span> <span class="n">os</span>

<span class="kn">from</span> <span class="n">check_pk_and_py</span> <span class="kn">import</span> <span class="n">microservice</span>

<span class="k">class</span> <span class="nc">TestPokeOnlyDown</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'cp /etc/hosts /etc/hosts.orig'</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'echo "127.0.0.1</span><span class="se">\t</span><span class="s">pokeapi.co" &gt;&gt; /etc/hosts'</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">test_poke_down</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nf">microservice</span><span class="p">(</span><span class="s">'pikachu'</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="nf">subTest</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">assertIsNotNone</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s">'is_python_module'</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="nf">subTest</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">assertIsNone</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s">'is_pokemon'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'cp /etc/hosts.orig /etc/hosts'</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'rm /etc/hosts.orig'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestPypiOnlyDown</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'cp /etc/hosts /etc/hosts.orig'</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'echo "127.0.0.1</span><span class="se">\t</span><span class="s">pypi.org" &gt;&gt; /etc/hosts'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_pypi_down</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nf">microservice</span><span class="p">(</span><span class="s">'tensorflow'</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="nf">subTest</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">assertIsNone</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s">'is_python_module'</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="nf">subTest</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">assertIsNotNone</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s">'is_pokemon'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'cp /etc/hosts.orig /etc/hosts'</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'rm /etc/hosts.orig'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestPypiPokeDown</span><span class="p">(</span><span class="n">unittest</span><span class="p">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'cp /etc/hosts /etc/hosts.orig'</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'echo "127.0.0.1</span><span class="se">\t</span><span class="s">pypi.org" &gt;&gt; /etc/hosts'</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'echo "127.0.0.1</span><span class="se">\t</span><span class="s">pokeapi.co" &gt;&gt; /etc/hosts'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_pypi_poke_down</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nf">microservice</span><span class="p">(</span><span class="s">'ditto'</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="nf">subTest</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">assertIsNone</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s">'is_python_module'</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="nf">subTest</span><span class="p">():</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">assertIsNone</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s">'is_pokemon'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'cp /etc/hosts.orig /etc/hosts'</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="s">'rm /etc/hosts.orig'</span><span class="p">)</span>
</code></pre></div></div>

<p>Run the tests as a user (such as root) who is allowed to edit <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file. All the three test cases should pass now. The quality of the software is maintained!</p>

  </div>


  <a href="/blogs">&lt; To Blog home</a><a class="u-url" href="/2021/01/22/fmea-of-a-microservice-that-uses-third-party-apis.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Manoj Vignesh K M</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">

            <li><p class="rss-subscribe">subscribe <a href="/feed.xml">via RSS</a></p></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://www.linkedin.com/in/kmmanoj"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">kmmanoj</span></a></li><li><a href="https://www.twitter.com/kmmanojv96"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">kmmanojv96</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Manoj&#39;s articulated knowledge base of cybersecurity research</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
